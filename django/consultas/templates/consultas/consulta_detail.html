{% extends 'consultas/base_vet.html' %}

{% block title %}Detalhes da Consulta - Painel Veterin√°rio{% endblock %}

{% block breadcrumb %}
<a href="{% url 'consultas:consulta_list' %}">Consultas</a> > Detalhes
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>üìã Detalhes da Consulta</h2>
        <div style="display: flex; gap: 10px;">
            {% if consulta.pode_editar %}
            <a href="{% url 'consultas:consulta_update' consulta.pk %}" class="btn btn-warning btn-sm">Editar</a>
            {% endif %}
            {% if consulta.pode_iniciar_atendimento %}
            <form method="post" action="{% url 'consultas:consulta_iniciar' consulta.pk %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-success btn-sm">Iniciar Atendimento</button>
            </form>
            {% endif %}
            {% if consulta.pode_cancelar %}
            <form method="post" action="{% url 'consultas:consulta_cancelar' consulta.pk %}" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja cancelar esta consulta?');">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-sm">Cancelar Consulta</button>
            </form>
            {% endif %}
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div>
            <h3 style="color: #2c3e50; margin-bottom: 15px;">Informa√ß√µes da Consulta</h3>
            <p><strong>Data/Hora:</strong> {{ consulta.data_hora|date:"d/m/Y H:i" }}</p>
            <p><strong>Tipo:</strong> {{ consulta.get_tipo_display }}</p>
            <p><strong>Status:</strong> 
                <span class="badge badge-{% if consulta.status == 'AGENDADA' %}primary{% elif consulta.status == 'CONFIRMADA' %}success{% elif consulta.status == 'REALIZADA' %}secondary{% elif consulta.status == 'CANCELADA' %}danger{% else %}warning{% endif %}">
                    {{ consulta.get_status_display }}
                </span>
            </p>
            <p><strong>Motivo:</strong> {{ consulta.motivo }}</p>
            {% if consulta.observacoes %}
            <p><strong>Observa√ß√µes:</strong> {{ consulta.observacoes }}</p>
            {% endif %}
        </div>
        
        <div>
            <h3 style="color: #2c3e50; margin-bottom: 15px;">Informa√ß√µes do Animal</h3>
            <p><strong>Nome:</strong> {{ consulta.animal.nome }}</p>
            <p><strong>Esp√©cie:</strong> {{ consulta.animal.tipo_animal }}</p>
            <p><strong>Ra√ßa:</strong> {{ consulta.animal.raca }}</p>
            <p><strong>Sexo:</strong> {{ consulta.animal.get_sexo_display }}</p>
            {% if consulta.animal.idade_anos %}
            <p><strong>Idade:</strong> {{ consulta.animal.idade_anos }} anos</p>
            {% endif %}
            <p><strong>Propriet√°rio:</strong> {{ consulta.animal.proprietario.get_full_name|default:consulta.animal.proprietario.username }}</p>
        </div>
    </div>
</div>

{% if prontuario %}
<div class="card">
    <div class="card-header">
        <h2>üìù Prontu√°rio</h2>
        <a href="{% url 'consultas:prontuario_update' prontuario.pk %}" class="btn btn-warning btn-sm">Editar Prontu√°rio</a>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
        {% if prontuario.peso %}<p><strong>Peso:</strong> {{ prontuario.peso }} kg</p>{% endif %}
        {% if prontuario.temperatura %}<p><strong>Temperatura:</strong> {{ prontuario.temperatura }} ¬∞C</p>{% endif %}
        {% if prontuario.frequencia_cardiaca %}<p><strong>FC:</strong> {{ prontuario.frequencia_cardiaca }} bpm</p>{% endif %}
        {% if prontuario.frequencia_respiratoria %}<p><strong>FR:</strong> {{ prontuario.frequencia_respiratoria }} rpm</p>{% endif %}
    </div>
    
    <div style="margin-bottom: 15px;">
        <h4>Anamnese</h4>
        <p style="white-space: pre-wrap;">{{ prontuario.anamnese }}</p>
    </div>
    
    <div style="margin-bottom: 15px;">
        <h4>Exame F√≠sico</h4>
        <p style="white-space: pre-wrap;">{{ prontuario.exame_fisico }}</p>
    </div>
    
    <div style="margin-bottom: 15px;">
        <h4>Diagn√≥stico</h4>
        <p style="white-space: pre-wrap;">{{ prontuario.diagnostico }}</p>
    </div>
    
    <div style="margin-bottom: 15px;">
        <h4>Tratamento</h4>
        <p style="white-space: pre-wrap;">{{ prontuario.tratamento }}</p>
    </div>
    
    {% if prontuario.observacoes %}
    <div>
        <h4>Observa√ß√µes</h4>
        <p style="white-space: pre-wrap;">{{ prontuario.observacoes }}</p>
    </div>
    {% endif %}
</div>

<div class="card">
    <div class="card-header">
        <h2>üíä Receitas</h2>
        <a href="{% url 'consultas:receita_create' prontuario.pk %}" class="btn btn-primary btn-sm">+ Adicionar Receita</a>
    </div>
    
    {% if receitas %}
    <table class="table">
        <thead>
            <tr>
                <th>Medicamento</th>
                <th>Dosagem</th>
                <th>Frequ√™ncia</th>
                <th>Dura√ß√£o</th>
                <th>Via</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for receita in receitas %}
            <tr>
                <td><strong>{{ receita.medicamento }}</strong></td>
                <td>{{ receita.dosagem }}</td>
                <td>{{ receita.frequencia }}</td>
                <td>{{ receita.duracao }}</td>
                <td>{{ receita.get_via_administracao_display }}</td>
                <td>
                    <a href="{% url 'consultas:receita_update' receita.pk %}" class="btn btn-warning btn-sm">Editar</a>
                    <a href="{% url 'consultas:receita_delete' receita.pk %}" class="btn btn-danger btn-sm" onclick="return confirm('Tem certeza?');">Excluir</a>
                </td>
            </tr>
            {% if receita.instrucoes %}
            <tr>
                <td colspan="6" style="background: #f8f9fa; padding-left: 40px;">
                    <small><strong>Instru√ß√µes:</strong> {{ receita.instrucoes }}</small>
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: #7f8c8d; padding: 20px;">Nenhuma receita prescrita.</p>
    {% endif %}
</div>

{% else %}
<div class="card">
    <div class="card-header">
        <h2>üìù Prontu√°rio</h2>
    </div>
    <p style="text-align: center; color: #7f8c8d; padding: 40px;">
        Prontu√°rio ainda n√£o foi criado para esta consulta.<br><br>
        {% if consulta.status in 'EM_ATENDIMENTO,AGENDADA,CONFIRMADA' %}
        <a href="{% url 'consultas:prontuario_create' consulta.pk %}" class="btn btn-primary">Criar Prontu√°rio</a>
        {% endif %}
    </p>
</div>
{% endif %}

<div class="card">
    <div class="card-header">
        <h2>üìú Hist√≥rico</h2>
    </div>
    
    {% if historico %}
    <ul style="list-style: none;">
        {% for item in historico %}
        <li style="padding: 10px; border-bottom: 1px solid #ecf0f1;">
            <strong>{{ item.get_acao_display }}</strong> - {{ item.criado_em|date:"d/m/Y H:i" }}<br>
            <small style="color: #7f8c8d;">{{ item.descricao }} | Por: {{ item.usuario.get_full_name|default:item.usuario.username }}</small>
        </li>
        {% endfor %}
    </ul>
    {% endif %}
</div>
{% endblock %}
